<?xml version="1.0" encoding="utf-8"?>
<data>
    <record id="view_task_form_fs_kpi_inherit" model="ir.ui.view">
        <field name="name">project.task.form.fs.kpi.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">


             <xpath expr="//sheet" position="inside">
                <div class="alert alert-success o_FS_accepted_banner"
                    invisible="fs_status != 'accepted'">
                    <strong>Tarea aceptada.</strong> Puede iniciar y validar la intervención.
                </div>
            </xpath>

                        <!-- Ocultar por estado FS -->
            <xpath expr="//button[@name='action_timer_start']" position="attributes">
                <attribute name="invisible">fs_status != 'accepted'</attribute>
                <!-- not display_timesheet_timer or timer_start or not total_hours_spent or has_template_ancestor or has_project_template-->
            </xpath>

            <!-- Botones en header: visibles solo en etapa de planificación -->
            <xpath expr="//form/header" position="inside">
                <button name="action_fs_accept"
                        type="object"
                        string="Aceptar"
                        class="btn-primary"
                        groups="industry_fsm.group_fsm_user,!project.group_project_manager"
                        invisible="fs_decision_locked"/>

                <button name="action_fs_reject"
                        type="object"
                        string="Rechazar"
                        class="btn-secondary"
                        groups="industry_fsm.group_fsm_user,!project.group_project_manager"
                        invisible="fs_decision_locked"/>

            </xpath>

            <!-- Nueva pestaña para historial KPI -->
            <xpath expr="//sheet/notebook" position="inside">
                <page string="Historial de cambios" groups="industry_fsm.group_fsm_manager">
                    <field name="task_kpi_ids" nolabel="1">
                        <list>
                            <field name="change_date"/>
                            <field name="user_id"/>
                            <field name="previous_status"/>
                            <field name="current_status"/>
                            <field name="reason"/>
                            <field name="reschedule_date"/>
                            <field name="change_count"/>
                        </list>
                    </field>
                </page>
            </xpath>
        </field>
    </record>
</data>
