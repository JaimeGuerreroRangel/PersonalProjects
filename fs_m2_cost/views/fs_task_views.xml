<?xml version="1.0" encoding="utf-8"?>
<data noupdate="1">
    <record id="view_task_form_fs_inherit" model="ir.ui.view">
        <field name="name">project.task.form.field.service.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <!-- Metemos el smart button en la button_box de la tarea -->
            <xpath expr="//sheet//div[@name='button_box']" position="inside">
                <button name="action_view_approval_requests"
                        type="object"
                        class="oe_stat_button"
                        invisible="approval_count == 0">
                    <field name="approval_count" widget="statinfo" string="Aprobaciones"/>
                </button>
            </xpath>
            
              <!-- üî∏ Alerta arriba del formulario cuando no hay entrega completa -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning"
                    invisible="fs_related_sale_line_id != False or fs_delivery_status != 'full'">
                    <span>
                        No es posible planear por falta de entrega de materiales.
                    </span>
                </div>
            </xpath>

            <!-- üî∏ Hacer date_deadline de solo lectura si no se ha entregado todo -->
            <xpath expr="/form/sheet/group/group/div[@id='date_deadline_and_recurring_task']/field[@name='date_deadline']" position="attributes">
                <attribute name="force_save">1</attribute>
                <attribute name="readonly">fs_delivery_status != "full" and fs_service_type_id != 'Colocaci√≥n'</attribute>
            </xpath>
            
            <xpath expr="//field[@name='user_ids']" position="attributes">
                <!-- Contexto: pasamos la especialidad de la tarea al search de res.users -->
                <attribute name="context">
                    {
                        'fs_task_specialty_id': fs_service_specialty_id
                    }
                </attribute>
            </xpath>

            <xpath expr="/form/sheet/notebook/page[@id='timesheets_tab']/field[@name='timesheet_ids']/list//field[@name='name']" position="after">
                <field name="fs_m2_real" optional="show"/>
                <field name="fs_m2_cost" optional="show"/>
                <field name="fs_progress_pct" optional="show"/>
            </xpath>


            <xpath expr="/form/sheet/group/group/field[@name='user_ids']" position="after">
                <field name="fs_fecha_estimada_instalacion" readonly="1"/>
            </xpath>

            <xpath expr="//sheet/notebook"  position="inside">
                <page string="Field Service">
                    <group string="Detalles del servicio">
                        <field name="fs_sequence" readonly="1"/>
                        <field name="fs_delivery_status"  widget="badge" readonly="1"/>
                        <field name="fs_effective_date" readonly="1"/>
                        <field name="sale_order_id" readonly="1"/>
                        <field name="fs_related_sale_line_id" domain="[('order_id', '=', sale_order_id)]" readonly="1"/>
                        <field name="fs_service_type_id" readonly="1"/>
                        <field name="fs_service_specialty_id" readonly="1"/>
                        <field name="fs_expected_m2" readonly="1"/>
                    </group>
                    <group string="Direccion de instalaci√≥n">
                        <field name="fs_link_google_maps" readonly="1"/>
                        <field name="fs_service_location_id" readonly="1"/>
                        <field name="fs_service_installation_id" readonly="1"/>
                    </group>
                </page>
            </xpath>
            <!-- Restringir dominio de user_ids seg√∫n especialidad -->
            <xpath expr="//field[@name='user_ids']" position="attributes">
                <attribute name="domain">[('specialty_ids','in', fs_service_specialty_id)]</attribute>
            </xpath>
        </field>
    </record>
</data>
