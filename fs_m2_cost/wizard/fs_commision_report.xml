<data>

    <record id="action_fs_timesheet_report_pdf" model="ir.actions.report">
        <field name="name">Informe reembolso socio</field>
        <field name="model">fs.timesheet.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">fs_m2_cost.fs_timesheet_report_template</field>
        <field name="report_file">fs_m2_cost.fs_timesheet_report_template</field>
    </record>

    <template id="fs_timesheet_report_template">
        <t t-call="web.html_container">
            <!-- Normalmente solo hay un wizard -->
            <t t-foreach="docs" t-as="o">

                <!-- ============================
                     PÁGINAS POR COLABORADOR
                     ============================ -->
                <!-- Sacamos la lista de colaboradores con líneas -->
                <t t-set="users" t-value="o.line_ids.mapped('user_id').sorted(key=lambda u: u.name)"/>

                <!-- Una página por colaborador -->
                <t t-foreach="users" t-as="u">
                    <t t-set="user_lines" t-value="o.line_ids.filtered(lambda l: l.user_id == u)"/>
                    <t t-set="user_total" t-value="sum(user_lines.mapped('fs_m2_cost'))"/>
                    <t t-set="user_paid_total" t-value="sum(user_lines.filtered(lambda l: l.is_paid).mapped('fs_m2_cost'))"/>
                    <t t-set="user_pending_total" t-value="user_total - user_paid_total"/>

                    <t t-call="web.external_layout">
                        <div class="page">
                            <h2>Informe reembolso socio</h2>

                            <!-- Cabecera específica del colaborador -->
                            <p>
                                <strong>Fecha del reporte:</strong>
                                <span t-esc="o.report_date"/>
                            </p>
                            <p>
                                <strong>ID de socio:</strong>
                                <span t-esc="u.ref or ''"/>
                            </p>
                            <p>
                                <strong>Nombre del colaborador:</strong>
                                <span t-esc="u.name"/>
                            </p>
                            <p>
                                <strong>Método de reembolso:</strong>
                                <span t-esc="o.reimbursement_method"/>
                            </p>
                            <p>
                                <strong>Proveedor:</strong>
                                <span t-esc="o.provider_name"/>
                            </p>

                            <br/>

                            <!-- Detalle solo de este colaborador -->
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Fecha trans</th>
                                        <th>Tarea</th>
                                        <th>Colaborador</th>
                                        <th>Orden de venta</th>
                                        <th>Servicio</th>
                                        <th>Precio Unitario</th>
                                        <th>Cantidad m2</th>
                                        <th>M2 Faltantes</th>
                                        <th>Estatus pago</th>
                                        <th class="text-right">Total reembolso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="user_lines" t-as="line">
                                        <td><span t-esc="line.date"/></td>
                                        <td><span t-esc="line.fs_sequence"/></td>
                                        <td><span t-esc="line.user_id.name"/></td>
                                        <td><span t-esc="line.sale_order_id"/></td>
                                        <td><span t-esc="line.product_code"/></td>
                                        <td><span t-esc="line.unit_rate"/></td>
                                        <td><span t-esc="line.qty_m2"/></td>
                                        <td><span t-esc="line.pending_m2"/></td>
                                        <td>
                                            <t t-if="line.is_paid">
                                                <span>Pagado</span>
                                            </t>
                                            <t t-else="">
                                                <span>Pendiente</span>
                                            </t>
                                        </td>

                                        <td class="text-right">
                                            <span t-esc="line.fs_m2_cost"/>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="9" class="text-right"><strong>Total colaborador</strong></td>
                                        <td class="text-right"><span t-esc="user_total"/></td>
                                    </tr>
                                    <tr>
                                        <td colspan="9" class="text-right"><strong>Total pagado</strong></td>
                                        <td class="text-right"><span t-esc="user_paid_total"/></td>
                                    </tr>
                                    <tr>
                                        <td colspan="9" class="text-right"><strong>Saldo pendiente</strong></td>
                                        <td class="text-right"><span t-esc="user_pending_total"/></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </t>
                </t>

                <!-- ============================
                     PÁGINA RESUMEN CONSOLIDADO
                     ============================ -->


                <t t-set="total_paid" t-value="sum(o.line_ids.filtered(lambda l: l.is_paid).mapped('fs_m2_cost'))"/>
                <t t-set="total_pending" t-value="o.total_amount - total_paid"/>

                <t t-call="web.external_layout">
                    <div class="page">
                        <h2>Informe reembolso socio - Resumen consolidado</h2>

                        <p>
                            <strong>Fecha del reporte:</strong>
                            <span t-esc="o.report_date"/>
                        </p>
                        <p>
                            <strong>Método de reembolso:</strong>
                            <span t-esc="o.reimbursement_method"/>
                        </p>
                        <p>
                            <strong>Proveedor:</strong>
                            <span t-esc="o.provider_name"/>
                        </p>

                        <br/>

                        <table class="table table-sm o_main_table">
                            <thead>
                                <tr>
                                    <th>Fecha trans</th>
                                    <th>Tarea</th>
                                    <th>Colaborador</th>
                                    <th>Orden de venta</th> 
                                    <th>Servicio</th>
                                    <th>Precio Unitario</th>
                                    <th>Cantidad m2</th>
                                    <th>M2 Faltantes</th>
                                    <th>Estatus pago</th>
                                    <th class="text-right">Total reembolso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="o.line_ids" t-as="line">
                                    <td><span t-esc="line.date"/></td>
                                    <td><span t-esc="line.fs_sequence"/></td>
                                    <td><span t-esc="line.user_id.name"/></td>
                                    <td><span t-esc="line.sale_order_id"/></td>
                                    <td><span t-esc="line.product_code"/></td>
                                    <td><span t-esc="line.unit_rate"/></td>
                                    <td><span t-esc="line.qty_m2"/></td>
                                    <td><span t-esc="line.pending_m2"/></td>
                                    <td>
                                        <t t-if="line.is_paid"><span>Pagado</span></t>
                                        <t t-else=""><span>Pendiente</span></t>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="line.fs_m2_cost"/>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="9" class="text-right"><strong>Total general</strong></td>
                                    <td class="text-right"><span t-esc="o.total_amount"/></td>
                                </tr>
                                <tr>
                                    <td colspan="9" class="text-right"><strong>Total pagado</strong></td>
                                    <td class="text-right"><span t-esc="total_paid"/></td>
                                </tr>
                                <tr>
                                    <td colspan="9" class="text-right"><strong>Saldo pendiente de pago</strong></td>
                                    <td class="text-right"><span t-esc="total_pending"/></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </t>

            </t>
        </t>
    </template>

</data>
